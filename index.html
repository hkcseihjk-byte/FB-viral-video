<!doctype html>
<html lang="bn">
<head>
    <script src='//libtl.com/sdk.js' data-zone='10657834' data-sdk='show_10657834'></script>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Viral Zone</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Hind+Siliguri:wght@400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<script src="https://telegram.org/js/telegram-web-app.js"></script>

<script src='//libtl.com/sdk.js' data-zone='10657834' data-sdk='show_10657834'></script>
<script>
    (function(s){
        s.dataset.zone='10656312';
        s.src='https://gizokraijaw.net/vignette.min.js';
    })([document.documentElement, document.body].filter(Boolean).pop().appendChild(document.createElement('script')));
</script>
<script async data-cfasync='false' data-zone='214627' src='https://quge5.com/88/tag.min.js'></script>

<style>
/* --- DESIGN SYSTEM --- */
:root { --primary: #8b5cf6; --primary-gradient: linear-gradient(135deg, #8b5cf6, #ec4899); --bg-main: #0f0f23; --bg-card: #1a1a2e; --bg-nav: rgba(30, 30, 48, 0.95); --text-main: #ffffff; --text-muted: #9ca3af; --border: 1px solid rgba(255,255,255,0.08); }
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body { margin: 0; background: var(--bg-main); color: var(--text-main); font-family: 'Poppins', 'Hind Siliguri', sans-serif; padding-bottom: 90px; }
.app { max-width: 500px; margin: 0 auto; padding: 12px; }

.header { background: linear-gradient(to bottom, #1e1e30, #151525); padding: 20px; border-radius: 16px; text-align: center; border: var(--border); margin-bottom: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); }
.title { font-size: 26px; font-weight: 800; color: #a855f7; margin: 0; letter-spacing: 1px; }
.subtitle { font-size: 12px; color: var(--text-muted); margin-top: 5px; }

.search-wrapper { position: relative; margin-bottom: 15px; }
.search-input { width: 100%; padding: 14px 20px; padding-right: 50px; border-radius: 50px; background: #232336; border: var(--border); color: white; font-size: 14px; outline: none; transition: 0.3s; }
.search-input:focus { border-color: #8b5cf6; background: #2a2a40; }
.search-icon { position: absolute; right: 5px; top: 5px; background: var(--primary); width: 38px; height: 38px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 14px; }

.filter-scroll { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; margin-bottom: 15px; scrollbar-width: none; }
.filter-scroll::-webkit-scrollbar { display: none; }
.filter-btn { position: relative; padding: 8px 18px; background: var(--bg-card); border: var(--border); color: #ccc; border-radius: 50px; font-size: 13px; white-space: nowrap; cursor: pointer; margin-top: 8px; margin-right: 5px; }
.filter-btn.active { background: var(--primary-gradient); color: white; border: none; padding: 9px 19px; }
.badge { position: absolute; top: -6px; right: -2px; background: #ef4444; color: white; font-size: 9px; font-weight: bold; height: 18px; min-width: 18px; padding: 0 4px; border-radius: 10px; display: flex; align-items: center; justify-content: center; border: 2px solid var(--bg-main); z-index: 10; }

.cards { display: flex; flex-direction: column; gap: 15px; }
.card { background: var(--bg-card); border-radius: 16px; overflow: hidden; border: var(--border); box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
.banner-wrapper { width: 100%; overflow: hidden; border-radius: 12px; margin: 5px 0; text-align: center; background: #000; }
.banner-wrapper img { max-width: 100%; height: auto; display: block; margin: 0 auto; }
.media { position: relative; padding-bottom: 56.25%; background: black; }
.media img { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; }
.heart-btn { position: absolute; top: 10px; right: 10px; width: 36px; height: 36px; border-radius: 50%; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); border: none; color: white; display: flex; align-items: center; justify-content: center; font-size: 16px; cursor: pointer; }
.meta { padding: 15px; }

.meta-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; margin-bottom: 10px; }
.meta h3 { margin: 0; font-size: 16px; line-height: 1.4; font-weight: 600; flex: 1; }
.view-count-badge { font-size: 12px; font-weight: 500; color: #d1d5db; background: rgba(255, 255, 255, 0.1); padding: 5px 12px; border-radius: 8px; display: flex; align-items: center; gap: 6px; white-space: nowrap; }

.actions { display: flex; gap: 10px; }
.unlock-btn { flex: 1; padding: 12px; border-radius: 10px; border: none; background: var(--primary-gradient); color: white; font-weight: 700; font-size: 13px; text-transform: uppercase; box-shadow: 0 4px 12px rgba(236, 72, 153, 0.3); cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; }
.unlock-btn.done { background: #10b981; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3); }
.link-btn { width: 45px; background: #2d2d44; border: var(--border); border-radius: 10px; color: #a855f7; display: flex; align-items: center; justify-content: center; font-size: 16px; cursor: pointer; }

.info-box { background: var(--bg-card); border-radius: 16px; padding: 20px; border: var(--border); margin-bottom: 15px; }
.step { display: flex; gap: 15px; margin-bottom: 15px; }
.step-num { background: #2d2d44; color: #a855f7; width: 25px; height: 25px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 12px; flex-shrink: 0; }

/* BOTTOM NAV */
.bottom-nav { position: fixed; bottom: 10px; left: 10px; right: 10px; background: var(--bg-nav); backdrop-filter: blur(10px); border-radius: 20px; border: var(--border); display: flex; justify-content: space-around; padding: 8px 12px; max-width: 500px; margin: 0 auto; box-shadow: 0 10px 40px rgba(0,0,0,0.5); z-index: 100; }
.nav-item { background: none; border: none; color: #6b7280; cursor: pointer; position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 3px; width: auto; height: auto; }
.nav-item i { font-size: 18px; transition: 0.3s; }
.nav-text { font-size: 10px; font-weight: 500; font-family: 'Hind Siliguri', sans-serif; }
.nav-item.active { color: #ec4899; }
.nav-item.active i { transform: translateY(-2px); }
.nav-item.active::after { content: ''; position: absolute; bottom: -4px; left: 50%; transform: translateX(-50%); width: 4px; height: 4px; background: #ec4899; border-radius: 50%; }

.toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: #10b981; color: white; padding: 8px 20px; border-radius: 50px; font-size: 12px; font-weight: 600; display: none; z-index: 200; }
.single-view { position: fixed; inset: 0; background: var(--bg-main); z-index: 150; overflow-y: auto; padding: 15px; display: none; }
.single-view.active { display: block; }
.hidden { display: none; }
.fadeIn { animation: fadeIn 0.3s ease; }
@keyframes fadeIn { from{opacity:0;transform:translateY(10px);} to{opacity:1;transform:translateY(0);} }

/* AD POPUP STYLES */
.ad-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(5px); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; display: none; }
.ad-box { background: var(--bg-card); border-radius: 16px; overflow: hidden; width: 90%; max-width: 350px; text-align: center; position: relative; border: 1px solid #a855f7; box-shadow: 0 0 20px rgba(168, 85, 247, 0.4); }
.timer-badge { background: rgba(0,0,0,0.7); color: #fff; padding: 6px 16px; border-radius: 20px; position: absolute; top: 12px; left: 50%; transform: translateX(-50%); font-weight: bold; font-size: 14px; border: 1px solid #ec4899; z-index: 10; }
.ad-img { width: 100%; height: 200px; object-fit: cover; border-bottom: 2px solid #333; }
.ad-content { padding: 20px; }
.ad-content h3 { margin: 0 0 10px; color: #a855f7; font-size: 18px; }
.ad-content p { margin: 0; color: #ccc; font-size: 13px; line-height: 1.5; }
.close-ad-btn { width: 90%; background: #4b5563; color: #9ca3af; border: none; padding: 15px; border-radius: 10px; font-size: 16px; font-weight: bold; margin-top: 15px; cursor: not-allowed; transition: 0.3s; margin-bottom: 20px; }
.close-ad-btn.active { background: var(--primary-gradient); color: white; cursor: pointer; box-shadow: 0 4px 15px rgba(236, 72, 153, 0.4); }
</style>
</head>
<body>

<div class="app">
    <div id="monetagAdPopup" class="ad-overlay">
        <div class="ad-box">
            <div class="timer-badge" id="adTimer"><i class="fas fa-hourglass-half"></i> 00:05</div>
            <img src="https://images.unsplash.com/photo-1611162617474-5b21e879e113?q=80&w=600&auto=format&fit=crop" class="ad-img" alt="Sponsored Ad">
            <div class="ad-content">
                <h3>Sponsored Task</h3>
                <p>‡¶≠‡¶ø‡¶°‡¶ø‡¶ì‡¶ü‡¶ø ‡¶Ü‡¶®‡¶≤‡¶ï ‡¶ï‡¶∞‡¶§‡ßá ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶ü‡¶ø ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶® ‡¶è‡¶¨‡¶Ç ‡¶®‡¶ø‡¶ö‡ßá‡¶∞ ‡¶¨‡¶æ‡¶ü‡¶®‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</p>
            </div>
        </div>
        <button id="adContinueBtn" class="close-ad-btn">Please Wait...</button>
    </div>

    <div id="singleView" class="single-view">
        <button onclick="closeSingle()" style="background:#2d2d44; color:white; border:none; padding:10px 20px; border-radius:50px; margin-bottom:20px; display:flex; align-items:center; gap:8px;">
            <i class="fas fa-arrow-left"></i> ‡¶´‡¶ø‡¶∞‡ßá ‡¶Ø‡¶æ‡¶®
        </button>
        <div id="singleCardContainer"></div>
    </div>

    <div id="mainContent">
        <div class="header">
            <h1 class="title"> VIRAL ZONE VIDEO<i class="fas fa-fire" style="color:#ec4899"></i></h1>
            <div class="subtitle">Exclusive Premium Video </div>
        </div>

        <div id="homeSec" class="fadeIn">
            <div class="search-wrapper">
                <input id="searchInput" type="text" class="search-input" placeholder="‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®...">
                <div class="search-icon"><i class="fas fa-search"></i></div>
            </div>
            <div id="filterContainer" class="filter-scroll"></div>
            <div id="cards" class="cards">
                <div style="text-align:center; padding:30px; color:#666"><i class="fas fa-circle-notch fa-spin"></i> Loading...</div>
            </div>
        </div>

        <div id="likedSec" class="hidden fadeIn">
            <h3 style="color:#ec4899; margin-left:5px;">‚ù§Ô∏è ‡¶™‡¶õ‡¶®‡ßç‡¶¶‡ßá‡¶∞ ‡¶≠‡¶ø‡¶°‡¶ø‡¶ì</h3>
            <div id="likedCards" class="cards"></div>
        </div>

        <div id="tutSec" class="hidden fadeIn">
            <h3 style="color:#a855f7; margin-left:5px;">üé• ‡¶ü‡¶ø‡¶â‡¶ü‡ßã‡¶∞‡¶ø‡ßü‡¶æ‡¶≤</h3>
            <div class="info-box">
                <div id="tutEmbed" style="width:100%; aspect-ratio:16/9; background:#000; border-radius:10px; margin-bottom:20px;"></div>
                <div class="step"><div class="step-num">‡ßß</div><div style="font-size:13px; color:#ddd;">UNLOCK ‡¶¨‡¶æ‡¶ü‡¶®‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</div></div>
                <div class="step"><div class="step-num">‡ß®</div><div style="font-size:13px; color:#ddd;">‡¶™‡¶™‡¶Ü‡¶™ ‡¶Ü‡¶∏‡¶≤‡ßá ‡ß´ ‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶° ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶è‡¶¨‡¶Ç Continue ‡¶¨‡¶æ‡¶ü‡¶®‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</div></div>
                <div class="step"><div class="step-num">‡ß©</div><div style="font-size:13px; color:#ddd;">‡¶è‡¶≠‡¶æ‡¶¨‡ßá ‡ß´ ‡¶¨‡¶æ‡¶∞ (‡¶¨‡¶æ ‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡¶ø‡¶∑‡ßç‡¶ü ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶ï ‡¶¨‡¶æ‡¶∞) ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶¶‡ßá‡¶ñ‡¶≤‡ßá ‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶®‡•§</div></div>
            </div>
        </div>

        <div id="linkSec" class="hidden fadeIn">
            <h3 style="color:#a855f7; margin-left:5px;">üîó ‡¶™‡ßç‡¶∞‡ßü‡ßã‡¶ú‡¶®‡ßÄ‡ßü ‡¶≤‡¶ø‡¶Ç‡¶ï</h3>
            <div id="linkList" class="cards"></div>
        </div>
    </div>

    <div class="bottom-nav">
        <button class="nav-item active" onclick="nav('homeSec', this)">
            <i class="fas fa-home"></i>
            <span class="nav-text">‡¶π‡ßã‡¶Æ</span>
        </button>
        <button class="nav-item" onclick="nav('likedSec', this)">
            <i class="fas fa-heart"></i>
            <span class="nav-text">‡¶™‡¶õ‡¶®‡ßç‡¶¶</span>
        </button>
        <button class="nav-item" onclick="nav('tutSec', this)">
            <i class="fas fa-book-open"></i>
            <span class="nav-text">‡¶ü‡¶ø‡¶â‡¶ü‡ßã‡¶∞‡¶ø‡ßü‡¶æ‡¶≤</span>
        </button>
        <button class="nav-item" onclick="nav('linkSec', this)">
            <i class="fas fa-link"></i>
            <span class="nav-text">‡¶≤‡¶ø‡¶Ç‡¶ï</span>
        </button>
    </div>
    <div id="toast" class="toast">Link Copied!</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import { getDatabase, ref, onValue, runTransaction } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAO5AA5Jb5kgMZQ8dUv1NnG3xEqNAxAhCs",
  authDomain: "update-3f9c0.firebaseapp.com",
  databaseURL: "https://update-3f9c0-default-rtdb.firebaseio.com",
  projectId: "update-3f9c0",
  storageBucket: "update-3f9c0.firebasestorage.app",
  messagingSenderId: "339256067632",
  appId: "1:339256067632:web:05ede89a6a1fc8eb958ff5",
  measurementId: "G-LKDL3SNJ70"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const tg = window.Telegram.WebApp; tg.expand();
const currentUserId = tg.initDataUnsafe?.user?.id || Math.floor(Math.random() * 90000000) + 10000000;

let allVideos=[], filters=[], menuLinks=[];
let bannerAds=[]; 
let settings={ ads_limit: 20, bot_app_link: "", monetag_smartlink: "" };
let currentFilter = 'all';

function init() {
    onValue(ref(db, 'settings'), s => { 
        if(s.val()) {
            settings = s.val();
            if(settings.tutorial_id) document.getElementById('tutEmbed').innerHTML=`<iframe src="${settings.tutorial_id}" style="width:100%;height:100%;border:0" allowfullscreen></iframe>`;
        }
    });

    onValue(ref(db, 'ads_config'), s => { 
        bannerAds = [];
        if(s.val() && s.val().banners) Object.values(s.val().banners).forEach(b => bannerAds.push(b));
        renderCards(); 
    });

    onValue(ref(db, 'links'), s => { menuLinks=[]; if(s.val()) Object.values(s.val()).forEach(v=>menuLinks.push(v)); renderLinks(); });
    onValue(ref(db, 'filters'), s => { filters=[]; if(s.val()) Object.values(s.val()).forEach(v=>filters.push(v)); });

    onValue(ref(db, 'videos'), s => {
        allVideos = [];
        if(s.val()) Object.entries(s.val()).forEach(([k,v])=>allVideos.push({id:k,...v}));
        allVideos.reverse();
        
        renderFilters();
        renderCards(); 
        renderLiked();
        checkDeepLink();
    });
}

function checkDeepLink() {
    const startParam = tg.initDataUnsafe?.start_param || new URLSearchParams(window.location.search).get('file');
    if(startParam) {
        let videoId = startParam.split('_')[0];
        const targetVideo = allVideos.find(v => v.id === videoId);
        if(targetVideo) {
            openSingle(videoId);
        } else {
            showToast("‡¶≠‡¶ø‡¶°‡¶ø‡¶ì‡¶ü‡¶ø ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø!");
        }
    }
}

function getCount(cat) { return cat === 'all' ? allVideos.length : allVideos.filter(v => v.category === cat).length; }

function renderFilters() {
    const div = document.getElementById('filterContainer');
    let html = `<button class="filter-btn ${currentFilter==='all'?'active':''}" onclick="setFilter('all', this)">All <span class="badge">${getCount('all')}</span></button>`;
    filters.forEach(f => {
        html += `<button class="filter-btn ${currentFilter===f.id?'active':''}" onclick="setFilter('${f.id}', this)">${f.name} <span class="badge">${getCount(f.id)}</span></button>`;
    });
    div.innerHTML = html;
}

function renderCards() {
    const div = document.getElementById('cards');
    const q = document.getElementById('searchInput').value.toLowerCase();
    const list = allVideos.filter(v => (v.name.toLowerCase().includes(q)) && (currentFilter==='all' || v.category===currentFilter));
    
    div.innerHTML = list.length ? '' : '<p style="text-align:center;color:#666;margin-top:20px;">‡¶ï‡ßã‡¶®‡ßã ‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø</p>';
    
    list.forEach((v, index) => {
        div.appendChild(createCard(v));
        if ((index + 1) % 2 === 0 && bannerAds.length > 0) {
            const bannerDiv = document.createElement('div');
            bannerDiv.className = 'banner-wrapper';
            bannerDiv.innerHTML = bannerAds[Math.floor(Math.random() * bannerAds.length)];
            div.appendChild(bannerDiv);
        }
    });
}

function createCard(v) {
    const liked = getLiked().includes(v.id);
    const count = getProgress(v.id);
    const req = v.ad_watches_required || 5; 
    const isUnlocked = count >= req;
    
    const baseViews = v.views || (Math.floor(Math.random() * 880000) + 10000); 
    const realViews = v.view_count || 0;
    const totalViews = baseViews + realViews;
    const displayViews = totalViews.toLocaleString('en-IN'); 

    const el = document.createElement('div');
    el.className = 'card';
    el.innerHTML = `
        <div class="media">
            <img src="${v.image_url}" onerror="this.src='https://via.placeholder.com/400'">
            <button class="heart-btn" onclick="toggleLike('${v.id}')"><i class="${liked?'fas':'far'} fa-heart" style="color:${liked?'#ec4899':'white'}"></i></button>
        </div>
        <div class="meta">
            <div class="meta-header">
                <h3>${v.name}</h3>
                <div class="view-count-badge"><i class="fas fa-eye"></i> ${displayViews}</div>
            </div>
            <div class="actions">
                <button class="unlock-btn ${isUnlocked?'done':''}" onclick="handleUnlock('${v.id}', '${v.download_link}', ${req})">
                    ${isUnlocked ? '<i class="fas fa-download"></i> DOWNLOAD' : `<i class="fas fa-play"></i> UNLOCK (${count}/${req})`}
                </button>
                <button class="link-btn" onclick="copyLink('${v.id}')"><i class="fas fa-link"></i></button>
            </div>
        </div>`;
    return el;
}

window.copyLink = (id) => {
    const botLink = settings.bot_app_link || "";
    if(!botLink) { 
        const url = window.location.origin + window.location.pathname + '?file=' + id;
        navigator.clipboard.writeText(url); 
        showToast("Web Link Copied!"); 
        return; 
    }
    const tgLink = `${botLink}?startapp=${id}_${currentUserId}`;
    navigator.clipboard.writeText(tgLink);
    showToast("Share Link Copied!");
}

let countdownInterval;

window.handleUnlock = (id, link, req) => {
    const count = getProgress(id);
    if(count >= req) { window.open(link, '_blank'); return; }
    if(getDaily() >= (settings.ads_limit||20)) { showToast("Daily limit reached!"); return; }
    if(!settings.monetag_smartlink) { alert("Admin: Add Monetag Smartlink first!"); return; }

    showMonetagAd(id, req);
}

function showMonetagAd(videoId, req) {
    const popup = document.getElementById('monetagAdPopup');
    const timerDisplay = document.getElementById('adTimer');
    const continueBtn = document.getElementById('adContinueBtn');
    
    popup.style.display = 'flex';
    continueBtn.classList.remove('active');
    continueBtn.innerText = "Please Wait...";
    continueBtn.onclick = null; 
    
    let timeLeft = 5;
    timerDisplay.innerHTML = `<i class="fas fa-hourglass-half"></i> 00:0${timeLeft}`;
    
    clearInterval(countdownInterval);
    
    countdownInterval = setInterval(() => {
        timeLeft--;
        timerDisplay.innerHTML = `<i class="fas fa-hourglass-half"></i> 00:0${timeLeft}`;
        
        if(timeLeft <= 0) {
            clearInterval(countdownInterval);
            timerDisplay.innerHTML = `<i class="fas fa-check-circle" style="color:#10b981;"></i> Ready!`;
            continueBtn.classList.add('active');
            continueBtn.innerText = "Click Here to Continue";
            
            continueBtn.onclick = () => {
                window.open(settings.monetag_smartlink, '_blank');
                popup.style.display = 'none';
                
                incProgress(videoId);
                incDaily();
                
                const currentCount = getProgress(videoId);
                if(currentCount >= req) {
                    incrementViewCount(videoId);
                    showToast("Video Unlocked!");
                } else {
                    showToast(`Task Complete! (${currentCount}/${req})`);
                }
                
                renderCards();
                if(document.getElementById('singleView').classList.contains('active')) {
                    openSingle(videoId);
                }
            };
        }
    }, 1000);
}

function incrementViewCount(videoId) {
    const storageKey = 'viewed_event_' + videoId;
    if(localStorage.getItem(storageKey)) return;

    const vidRef = ref(db, 'videos/' + videoId + '/view_count');
    runTransaction(vidRef, (currentViews) => {
        return (currentViews || 0) + 1;
    }).then(() => {
        localStorage.setItem(storageKey, 'true'); 
    }).catch(err => console.error("View update failed", err));
}

function showToast(msg) { const t=document.getElementById('toast'); t.innerText=msg; t.style.display='block'; setTimeout(()=>t.style.display='none', 3000); }

function renderLinks() { 
    const d=document.getElementById('linkList'); 
    d.innerHTML=''; 
    menuLinks.forEach(l => { 
        d.innerHTML += `
        <div class="card" style="padding:15px;display:flex;align-items:center;gap:15px;">
            <i class="fas fa-link" style="color:#a855f7;font-size:20px"></i>
            <div style="flex:1"><b>${l.title}</b></div>
            <a href="${l.url}" target="_blank" style="background:#2d2d44;color:white;padding:5px 15px;border-radius:50px;text-decoration:none;font-size:12px">Open</a>
        </div>`; 
    }); 
}

function renderLiked() { const d=document.getElementById('likedCards'); const l=getLiked(); const v=allVideos.filter(x=>l.includes(x.id)); d.innerHTML = v.length?'':'<p style="text-align:center;color:gray;padding:20px">‡¶™‡¶õ‡¶®‡ßç‡¶¶‡ßá‡¶∞ ‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‡¶®‡ßá‡¶á</p>'; v.forEach(x=>d.appendChild(createCard(x))); }
window.nav = (id, btn) => { ['homeSec','likedSec','tutSec','linkSec'].forEach(s=>document.getElementById(s).classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); document.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('active')); btn.classList.add('active'); if(id==='homeSec') document.getElementById('mainContent').style.display='block'; }
window.setFilter = (id, btn) => { currentFilter=id; renderFilters(); renderCards(); }
document.getElementById('searchInput').oninput = renderCards;
function getLiked(){ return JSON.parse(localStorage.getItem('likes')||'[]'); }
window.toggleLike=(id)=>{ let l=getLiked(); if(l.includes(id)) l=l.filter(x=>x!==id); else l.push(id); localStorage.setItem('likes',JSON.stringify(l)); renderCards(); renderLiked(); }
function getProgress(id){ return parseInt(localStorage.getItem('p_'+id)||0); }
function incProgress(id){ localStorage.setItem('p_'+id, getProgress(id)+1); }
function getDaily(){ const d=JSON.parse(localStorage.getItem('daily')||'{}'); return d.date===new Date().toDateString()?d.count:0; }
function incDaily(){ localStorage.setItem('daily', JSON.stringify({date:new Date().toDateString(), count:getDaily()+1})); }

window.openSingle = (id) => { 
    const v = allVideos.find(x => x.id === id); 
    if(!v) return; 
    document.getElementById('mainContent').style.display='none'; 
    document.getElementById('singleView').classList.add('active'); 
    document.getElementById('singleCardContainer').innerHTML=''; 
    document.getElementById('singleCardContainer').appendChild(createCard(v)); 
    const newUrl = window.location.pathname + '?file=' + id;
    window.history.pushState({ path: newUrl }, '', newUrl);
}

window.closeSingle = () => { 
    document.getElementById('singleView').classList.remove('active'); 
    document.getElementById('mainContent').style.display='block'; 
    window.history.pushState({}, '', window.location.pathname); 
    renderCards(); 
}

init();
</script>

<script>
    (function(s){
        s.dataset.zone='10656322';
        s.src='https://al5sm.com/tag.min.js';
    })([document.documentElement, document.body].filter(Boolean).pop().appendChild(document.createElement('script')));
</script>
</body>
</html>

